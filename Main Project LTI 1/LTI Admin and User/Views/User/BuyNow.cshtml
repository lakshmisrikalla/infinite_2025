@model LTI.Models.PolicyViewModel
@{
    Layout = "~/Views/User/UserLayout.cshtml";
    ViewBag.Title = "Buy Insurance";
}

<body data-base-premium="@Model.BasePremium" data-base-months="@Model.DurationMonths">
    <div class="container mt-4">
        <div class="buy-card">
            <h3 class="mb-4">🛒 Buy: <span class="text-primary">@Model.PolicyName</span></h3>

            @if (TempData["DocRedirectMessage"] != null)
            {
                <div class="alert alert-warning">@TempData["DocRedirectMessage"]</div>
            }

            <form method="post" action="/User/ConfirmPurchase" onsubmit="return validateBeforeSubmit();">
                @Html.HiddenFor(model => model.PolicyID)
                <input type="hidden" name="UPI" id="upiInput" />
                <input type="hidden" name="extendEMI" id="extendEMIHidden" value="false" />

                <label class="form-label">Nominee Name:</label>
                <input type="text" name="nomineeName" class="form-control mb-3" required />

                <label class="form-label">Do you want EMI extension?</label>
                <input type="checkbox" id="extendEMI" />
                <div id="taxNote" class="text-warning mt-2" style="display:none;">
                    EMI extension adds 25% tax on extra months beyond the original duration.
                </div>

                <div class="section-title">EMI Duration</div>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Select EMI Duration:</label>
                        <select id="emiMonths" name="emiMonths" class="form-select"></select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Months to Pay Now:</label>
                        <select id="payNowMonths" name="payNowMonths" class="form-select"></select>
                    </div>
                </div>

                <button type="button" class="btn btn-outline-info mt-3" onclick="toggleBreakdown()">Monthly Breakdown</button>
                <div id="emiPlan" class="mt-3" style="display:none;"></div>

                <div id="durationConfirm" class="mt-4" style="display:none;">
                    <p><strong>Start Date:</strong> <span id="startDate"></span></p>
                    <p><strong>End Date:</strong> <span id="endDate"></span></p>
                    <label><input type="checkbox" id="termsCheck" /> I accept the terms and conditions</label>
                </div>

                <div class="section-title">Payment Method</div>
                <label class="form-label">Select Payment Method:</label>
                <select id="paymentMethod" name="paymentMethod" class="form-select mb-3 w-50">
                    <option value="">-- Select Payment Method --</option>
                    <option value="Credit Card">Credit Card</option>
                    <option value="Debit Card">Debit Card</option>
                    <option value="UPI">UPI</option>
                </select>

                <div id="creditFields" style="display:none;">
                    <label>Card Number:</label>
                    <input type="text" name="CardNumber" class="form-control mb-2" />
                    <label>Name on Card:</label>
                    <input type="text" name="CardName" class="form-control mb-2" />
                    <label>Expiry Date:</label>
                    <input type="text" name="CardExpiry" class="form-control mb-2" />
                    <label>CVV:</label>
                    <input type="text" name="CardCVV" class="form-control mb-2" />
                </div>

                <div id="debitFields" style="display:none;">
                    <label>Debit Card Number:</label>
                    <input type="text" name="DebitNumber" class="form-control mb-2" />
                    <label>Name on Card:</label>
                    <input type="text" name="DebitName" class="form-control mb-2" />
                    <label>Expiry Date:</label>
                    <input type="text" name="DebitExpiry" class="form-control mb-2" />
                    <label>CVV:</label>
                    <input type="text" name="DebitCVV" class="form-control mb-2" />
                </div>

                <div id="upiFields" style="display:none;">
                    <label>Enter your UPI ID:</label>
                    <input type="text" id="upiField" class="form-control mb-2" placeholder="yourname@bank" />
                </div>

                <div class="text-end mt-4">
                    <button type="submit" class="btn btn-success">Pay Now</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        function toggleExtension() {
            const checked = document.getElementById("extendEMI").checked;
            document.getElementById("extendEMIHidden").value = checked;
            document.getElementById("taxNote").style.display = checked ? "block" : "none";
            generateEMIOptions();
            calculateEMI();
        }

        function generateEMIOptions() {
            const baseMonths = parseInt(document.body.dataset.baseMonths);
            const emiSelect = document.getElementById("emiMonths");
            const payNowSelect = document.getElementById("payNowMonths");
            emiSelect.innerHTML = "";
            payNowSelect.innerHTML = "";

            const extend = document.getElementById("extendEMI").checked;
            const maxMonths = extend ? baseMonths + 4 : baseMonths;

            for (let i = baseMonths; i <= maxMonths; i++) {
                const opt = document.createElement("option");
                opt.value = i;
                opt.text = i + " months";
                emiSelect.appendChild(opt);
            }

            emiSelect.value = baseMonths;

            for (let i = 1; i <= maxMonths; i++) {
                const opt = document.createElement("option");
                opt.value = i;
                opt.text = i + " month" + (i > 1 ? "s" : "");
                payNowSelect.appendChild(opt);
            }

            payNowSelect.value = 1;
        }

        function calculateEMI() {
            const basePremium = parseFloat(document.body.dataset.basePremium);
            const baseMonths = parseInt(document.body.dataset.baseMonths);
            const selectedMonths = parseInt(document.getElementById("emiMonths").value);
            const payNowMonths = parseInt(document.getElementById("payNowMonths").value);
            const extend = document.getElementById("extendEMI").checked;

            const monthlyBase = basePremium / baseMonths;
            let output = "<ul>";
            let total = 0;
            let payNowTotal = 0;
            const today = new Date();
            const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];

            for (let i = 0; i < selectedMonths; i++) {
                const dueDate = new Date(today);
                dueDate.setMonth(today.getMonth() + i);
                const dateStr = dueDate.getDate() + " " + monthNames[dueDate.getMonth()] + " " + dueDate.getFullYear();

                let amount = monthlyBase;
                let label = "Base";
                if (extend && i >= baseMonths) {
                    const tax = monthlyBase * 0.25;
                    amount += tax;
                    label = "Base + 25% Tax";
                }

                output += `<li>Month ${i + 1} (${dateStr}): ₹${amount.toFixed(2)} (${label})</li>`;
                total += amount;
                if (i < payNowMonths) payNowTotal += amount;
            }

            output += `</ul>`;
            output += `<p><strong>Total Premium:</strong> ₹${total.toFixed(2)}</p>`;
            output += `<p><strong>Pay Now:</strong> ₹${payNowTotal.toFixed(2)} for ${payNowMonths} month(s)</p>`;
            document.getElementById("emiPlan").innerHTML = output;

            const startDate = new Date(today);
            const endDate = new Date(today);
            endDate.setMonth(today.getMonth() + selectedMonths);

            document.getElementById("startDate").textContent = startDate.toDateString();
            document.getElementById("endDate").textContent = endDate.toDateString();

            document.getElementById("durationConfirm").style.display = "block";
        }

        function showPaymentFields() {
            const method = document.getElementById("paymentMethod").value;

            document.getElementById("creditFields").style.display = "none";
            
            document.getElementById("debitFields").style.display = "none";
            document.getElementById("upiFields").style.display = "none";

            if (method === "Credit Card") {
                document.getElementById("creditFields").style.display = "block";
            } else if (method === "Debit Card") {
                document.getElementById("debitFields").style.display = "block";
            } else if (method === "UPI") {
                document.getElementById("upiFields").style.display = "block";
            }
        }

        function validateBeforeSubmit() {
            const termsAccepted = document.getElementById("termsCheck").checked;
            if (!termsAccepted) {
                alert("Please accept the terms and conditions before proceeding.");
                return false;
            }

            const emiMonths = parseInt(document.getElementById("emiMonths").value);
            const payNowMonths = parseInt(document.getElementById("payNowMonths").value);

            if (payNowMonths > emiMonths) {
                alert("You cannot pay more months than the selected EMI duration. Please reselect.");
                return false;
            }

            const paymentMethod = document.getElementById("paymentMethod").value;
            if (!paymentMethod) {
                alert("Please select a payment method.");
                return false;
            }

            if (paymentMethod === "UPI") {
                const upiField = document.getElementById("upiField");
                const upiValue = upiField ? upiField.value.trim() : "";
                if (!upiValue) {
                    alert("Please enter your UPI ID.");
                    return false;
                }
                document.getElementById("upiInput").value = upiValue;
            }

            return true;
        }

        function toggleBreakdown() {
            const breakdown = document.getElementById("emiPlan");
            breakdown.style.display = breakdown.style.display === "none" ? "block" : "none";
        }

        window.onload = function () {
            // Ensure all payment fields are hidden initially
            document.getElementById("creditFields").style.display = "none";
            document.getElementById("debitFields").style.display = "none";
            document.getElementById("upiFields").style.display = "none";

            generateEMIOptions();
            calculateEMI();

            document.getElementById("emiMonths").addEventListener("change", calculateEMI);
            document.getElementById("payNowMonths").addEventListener("change", calculateEMI);
            document.getElementById("extendEMI").addEventListener("change", toggleExtension);
            document.getElementById("paymentMethod").addEventListener("change", showPaymentFields);
        };
    </script>
</body>

